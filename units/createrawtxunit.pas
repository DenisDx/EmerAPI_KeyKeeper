unit CreateRawTXunit;

{$mode objfpc}{$H+}

interface

uses
  Classes, SysUtils, FileUtil, Forms, Controls, Graphics, Dialogs, StdCtrls,
  Grids, ExtCtrls, ComCtrls, Buttons,fpjson, EmerAPIBlockchainUnit, CryptoLib4PascalConnectorUnit;

type

  { TCreateRawTXForm }

  TCreateRawTXForm = class(TForm)
    BitBtn1: TBitBtn;
    bLoadTX: TButton;
    bRebuild: TButton;
    bTextTX: TButton;
    bTextTX1: TButton;
    bTextTX2: TButton;
    bTextTX3: TButton;
    bTextTX4: TButton;
    bTextTX5: TButton;
    bTextTX6: TButton;
    bTextTX7: TButton;
    Button1: TButton;
    Button10: TButton;
    Button11: TButton;
    Button12: TButton;
    Button13: TButton;
    Button14: TButton;
    Button15: TButton;
    Button16: TButton;
    Button17: TButton;
    Button18: TButton;
    Button19: TButton;
    Button2: TButton;
    Button20: TButton;
    Button21: TButton;
    Button22: TButton;
    Button23: TButton;
    Button24: TButton;
    Button25: TButton;
    Button26: TButton;
    Button27: TButton;
    Button28: TButton;
    Button29: TButton;
    Button3: TButton;
    Button30: TButton;
    Button31: TButton;
    Button32: TButton;
    Button33: TButton;
    Button34: TButton;
    Button4: TButton;
    Button5: TButton;
    Button6: TButton;
    Button7: TButton;
    Button8: TButton;
    Button9: TButton;
    CheckBox1: TCheckBox;
    CheckBox2: TCheckBox;
    CheckBox3: TCheckBox;
    CheckBox4: TCheckBox;
    CheckBox5: TCheckBox;
    CheckBox6: TCheckBox;
    ComboBox1: TComboBox;
    Edit1: TEdit;
    Edit10: TEdit;
    Edit11: TEdit;
    Edit12: TEdit;
    Edit13: TEdit;
    Edit14: TEdit;
    Edit15: TEdit;
    Edit2: TEdit;
    Edit3: TEdit;
    Edit4: TEdit;
    Edit5: TEdit;
    Edit6: TEdit;
    Edit7: TEdit;
    Edit8: TEdit;
    Edit9: TEdit;
    GroupBox2: TGroupBox;
    GroupBox4: TGroupBox;
    GroupBoxTXassembled: TGroupBox;
    GroupBoxTXOUT: TGroupBox;
    Inputs: TGroupBox;
    Label1: TLabel;
    Label10: TLabel;
    Label11: TLabel;
    Label12: TLabel;
    Label13: TLabel;
    Label14: TLabel;
    Label15: TLabel;
    Label16: TLabel;
    Label2: TLabel;
    Label3: TLabel;
    Label4: TLabel;
    Label5: TLabel;
    Label6: TLabel;
    Label7: TLabel;
    Label8: TLabel;
    Label9: TLabel;
    Memo1: TMemo;
    Memo2: TMemo;
    Memo3: TMemo;
    PageControl1: TPageControl;
    Panel1: TPanel;
    Panel2: TPanel;
    Panel3: TPanel;
    Panel4: TPanel;
    Splitter1: TSplitter;
    Splitter2: TSplitter;
    StringGrid1: TStringGrid;
    StringGrid2: TStringGrid;
    TabSheet1: TTabSheet;
    TabSheet2: TTabSheet;
    TabSheet3: TTabSheet;
    TabSheet4: TTabSheet;
    procedure BitBtn1Click(Sender: TObject);
    procedure Button17Click(Sender: TObject);
    procedure Button18Click(Sender: TObject);
    procedure Button19Click(Sender: TObject);
    procedure Button20Click(Sender: TObject);
    procedure Button21Click(Sender: TObject);
    procedure Button23Click(Sender: TObject);
    procedure Button24Click(Sender: TObject);
    procedure Button25Click(Sender: TObject);
    procedure Button26Click(Sender: TObject);
    procedure Button27Click(Sender: TObject);
    procedure Button28Click(Sender: TObject);
    procedure Button29Click(Sender: TObject);
    procedure Button30Click(Sender: TObject);
    procedure Button31Click(Sender: TObject);
    procedure Button32Click(Sender: TObject);
    procedure Button33Click(Sender: TObject);
    procedure Button34Click(Sender: TObject);
    procedure clearGrid1Row(row:integer);
    procedure clearGrid2Row(row:integer);
    procedure bRebuildClick(Sender: TObject);
    procedure bTextTX1Click(Sender: TObject);
    procedure bTextTX2Click(Sender: TObject);
    procedure bTextTX3Click(Sender: TObject);
    procedure bTextTX4Click(Sender: TObject);
    procedure bTextTX5Click(Sender: TObject);
    procedure bTextTX6Click(Sender: TObject);
    procedure bTextTX7Click(Sender: TObject);
    procedure Button10Click(Sender: TObject);
    procedure Button11Click(Sender: TObject);
    procedure Button12Click(Sender: TObject);
    procedure Button13Click(Sender: TObject);
    procedure Button15Click(Sender: TObject);
    procedure Button16Click(Sender: TObject);
    procedure Button1Click(Sender: TObject);
    procedure Button22Click(Sender: TObject);
    procedure Button2Click(Sender: TObject);
    procedure Button3Click(Sender: TObject);
    procedure Button4Click(Sender: TObject);
    procedure Button5Click(Sender: TObject);
    procedure Button6Click(Sender: TObject);
    procedure Button7Click(Sender: TObject);
    procedure Button8Click(Sender: TObject);
    procedure Button9Click(Sender: TObject);
    procedure Edit2Change(Sender: TObject);
    procedure Edit3Change(Sender: TObject);
    procedure Edit4Change(Sender: TObject);
    procedure FormCreate(Sender: TObject);
    procedure LoadhexTX(hextx:ansistring);
    procedure LoadbinTX(txbin:ansistring);
    procedure bLoadTXClick(Sender: TObject);
    procedure bTextTXClick(Sender: TObject);
    procedure StringGrid1EditingDone(Sender: TObject);
    procedure StringGrid1SelectCell(Sender: TObject; aCol, aRow: Integer;
      var CanSelect: Boolean);
    procedure StringGrid2EditingDone(Sender: TObject);
    procedure StringGrid2SelectCell(Sender: TObject; aCol, aRow: Integer;
      var CanSelect: Boolean);
    procedure showScriptData(buf:ansistring);
  private
    function addId():ansistring;
    procedure bcUpdated(sender:tObject);
    procedure AsyncAddressInfoDone(sender:TEmerAPIBlockchainThread;result:tJsonData);
  public

  end;

var
  CreateRawTXForm: TCreateRawTXForm=nil;

implementation

{$R *.lfm}
uses LoadTXUnit, Crypto, EmerTX, tsttransactionUnit, lazutf8sysutils
    ,EmerApiTestUnit
    ,UOpenSSLdef
    ,EmerAPIDebugConsoleUnit
    , MainUnit
    , HelperUnit
    ,emerapitypes ;

{ TCreateRawTXForm }
function TCreateRawTXForm.addId():ansistring;
begin

  result:='';
  if trim(Combobox1.Text)<>'' then
    if pos(' ',trim(Combobox1.Text))>0
        then result:=chr(strtoint(
           copy(
              trim(Combobox1.Text)
              ,1
              ,pos(' ',trim(Combobox1.Text))-1
              )))
        else result:=chr(strtoint(trim(Combobox1.Text)));
end;

procedure TCreateRawTXForm.LoadhexTX(hextx:ansistring);
begin
  LoadbinTX(hexToBuf(trim(hextx)));
end;

procedure TCreateRawTXForm.FormCreate(Sender: TObject);
begin
  StringGrid1.Cells[0,0]:='#';
  StringGrid1.Cells[1,0]:='UTXO Hash';
  StringGrid1.Cells[2,0]:='index';
  StringGrid1.Cells[3,0]:='Signature';
  StringGrid1.Cells[4,0]:='sequence';
  StringGrid1.Cells[5,0]:='witness';
  StringGrid1.Cells[6,0]:='Amount';
  StringGrid1.Cells[7,0]:='Script decode (read only)';

  StringGrid2.Cells[0,0]:='#';
  StringGrid2.Cells[1,0]:='Value';
  StringGrid2.Cells[2,0]:='Script';
  StringGrid2.Cells[3,0]:='Explain (read only)';

  StringGrid2.ColWidths[0]:=20;
  StringGrid2.ColWidths[1]:=100;

  StringGrid1.ColWidths[0]:=20;
  StringGrid1.ColWidths[1]:=450;
  StringGrid1.ColWidths[6]:=80;

end;

procedure TCreateRawTXForm.bTextTX1Click(Sender: TObject);
begin
  LoadhexTX('6606000001ed985b013882802b05dcdda6166e4249bcd35ba86d1168fcd3abe31c184d49beba11e886010000006b4830450221009cf06c20a812e3f9c46bd73733350561d3c46ebffcab02628b8a706a895f09910220267c241e9367c7b6aa42179f9411d99edc17247204cad2dd18d29c30777860cf0121025f81956d5826bad7d30daed2b5c8c98e72046c1ec8323da336445476183fb7cafeffffff02342b0f00000000001976a914d3b9b852eb9275882501967255232279ea43425788ac640000000000000032517503747379011e6d0e747374310a747374320a747374337576a9141499229323159c6f91e04e7d00ae34b2991e43b788ac19480000');
end;

procedure TCreateRawTXForm.bRebuildClick(Sender: TObject);
var tx:ttx;
    i,rc:integer;
    s:ansistring;
    n:qword;
begin

  tx.version:=strtoint64(edit2.Text);
  tx.time:=strtoint64(edit3.Text);
  tx.locktime:=strtoint64(edit4.Text);


  rc:=StringGrid1.RowCount-1;
  if (rc=1) and (trim(StringGrid1.Cells[1,1])='') then rc:=0;

  setLength(tx.ins,rc);


  n:=0;
  for i:=0 to rc-1 do if (trim(StringGrid1.Cells[1,i+1])<>'') and (pos('00000000',trim(StringGrid1.Cells[1,i+1]))<>1) then begin
    tx.ins[n].hash:=hexToBuf(StringGrid1.Cells[1,i+1]);
    tx.ins[n].index:=strtoint64(StringGrid1.Cells[2,i+1]);
    tx.ins[n].script:=hexToBuf(StringGrid1.Cells[3,i+1]);
    tx.ins[n].sequence:=strtoint64(StringGrid1.Cells[4,i+1]);
    if trim(StringGrid1.Cells[5,i+1])<>'' then begin
      //then raise exception.create('whitness is not supported here')
      s:=trim(StringGrid1.Cells[5,i+1])+' ';
      while trim(s)<>'' do begin
        setLength(tx.ins[n].witness,length(tx.ins[n].witness)+1);
        tx.ins[n].witness[length(tx.ins[n].witness)-1]:=hexToBuf(trim(copy(s,1,pos(' ',s))));
        delete(s,1,pos(' ',s));
        s:=trim(s)+' ';
      end;
    end else tx.ins[n].witness:=nil;
    inc(n);
  end;
  setLength(tx.ins,n);

  setLength(tx.outs,StringGrid2.RowCount-1);

  for i:=0 to StringGrid2.RowCount-1-1 do begin
    tx.outs[i].value:=strtoint64(StringGrid2.Cells[1,i+1]);
    tx.outs[i].script:=hexToBuf(StringGrid2.Cells[2,i+1]);
  end;


  memo3.Text:=bufToHex(packtx(tx));

  n:=0;
  for i:=0 to length(tx.outs)-1 do n:=n+ tx.outs[i].value;
  Label12.Caption:='Total spent: '+inttostr(n)+' ('+floattostr(n / 1000000)+' EMC); with 0.0001 fee: '+inttostr(n+100)+' ('+floattostr((n+100) / 1000000)+' EMC)';


end;


procedure TCreateRawTXForm.bTextTX2Click(Sender: TObject);
begin
  LoadhexTX('66060000f20e995b015cb420782caf458f74cec7b6c2b328f51d2795212664e046c85f4055231638c2000000006b483045022100d0b0fe6c6f730598365914f13d597df4c2e522bb4af9f03ae50742c69e842428022072a5ddc48ffeef17c1ac27db9f451bbbc5ecd46e4b16ceaf486d42af1d65707e012102f123349e17d9e42947115b494edc9c03ab30fb7b6c6428a032d2da95dc53f361feffffff02640000000000000033517503747374020f276d0e747374310a747374320a747374337576a9141499229323159c6f91e04e7d00ae34b2991e43b788ac5cb80e00000000001976a914ced2436c4d0169b69e8e71c413dc5c5b20f5376388ac30480000');
end;

procedure TCreateRawTXForm.bTextTX3Click(Sender: TObject);
begin
  LoadhexTX('020000005601a25b018ec686e5ab29ed8a8639c87f096ec8c227f250e16982c77145d0fc085a0c69d4000000006b4830450221009984b8e5089ff3bf457e048f84747e7cb06ab240cba4cd6d0601ad3d0d5f6eab022001fd13c70ce24d142ab4bd17aad260644b2eb8b0ac7c56c8b46753e532a28a80012102d873e50696be65983a1058a92fbc69fbb7763ddf4471ef8da9d52c5f347f9fd1ffffffff01dc410f00000000001976a914649e41b014a856eb56af9098696e8aaf5904b10388ac00000000');
end;

procedure TCreateRawTXForm.bTextTX4Click(Sender: TObject);
begin
  LoadhexTX('020000005601a25b018ec686e5ab29ed8a8639c87f096ec8c227f250e16982c77145d0fc085a0c69d40000000000ffffffff01dc410f00000000001976a914649e41b014a856eb56af9098696e8aaf5904b10388ac00000000');
end;

procedure TCreateRawTXForm.bTextTX5Click(Sender: TObject);
begin
 LoadhexTX('660600001fdea85b01396f8d137008dffb3219c6530b08b17ead8e2de97bfd15c3506128ba14750884000000006b483045022100a552f158faddcd5a3fe0754858261e187d491bf782c63d79fbf54a4886f97f9902205f30ece89635b4ae9a35dfe5cc47ec52d2f803f6392a389ed52753d68334f98b012102262220ac347a53521818010741dcf54c89375ecd9c1ee0549363a05ccf7d0df3feffffff027c250e00000000001976a9148ba74adc4a87000c744bacd70f4b07393c35aa4388ac6400000000000000fdb2035175086c6f6e676e616d65011e6d4d0802313233343536373839306162636465666768696a6b6c6d6e6f707172737475767778797a313233343536373839306162636465666768696a6b6c6d6e6f707172737475767778797a313233343536373839306162636465666768696a6b6c6d6e6f707172737475767778797a313233343536373839306162636465666768696a6b6c6d6e6f707172737475767778797a313233343536373839306162636465666768696a6b6c6d6e6f707172737475767778797a313233343536373839306162636465666768696a6b6c6d6e6f707172737475767778797a313233343536373839306162636465666768696a6b6c6d6e6f707172737475767778797a313233343536373839306162636465666768696a6b6c6d6e6f707172737475767778797a313233343536373839306162636465666768696a6b6c6d6e6f707172737475767778797a313233343536373839306162636465666768696a6b6c6d6e6f707172737475767778797a313233343536373839306162636465666768696a6b6c6d6e6f707172737475767778797a313233343536373839306162636465666768696a6b6c6d6e6f707172737475767778797a313233343536373839306162636465666768696a6b6c6d6e6f707172737475767778797a313233343536373839306162636465666768696a6b6c6d6e6f707172737475767778797a313233343536373839306162636465664d7c016768696a6b6c6d6e6f707172737475767778797a313233343536373839306162636465666768696a6b6c6d6e6f707172737475767778797a313233343536373839306162636465666768696a6b6c6d6e6f707172737475767778797a313233343536373839306162636465666768696a6b6c6d6e6f707172737475767778797a313233343536373839306162636465666768696a6b6c6d6e6f707172737475767778797a313233343536373839306162636465666768696a6b6c6d6e6f707172737475767778797a313233343536373839306162636465666768696a6b6c6d6e6f707172737475767778797a313233343536373839306162636465666768696a6b6c6d6e6f707172737475767778797a313233343536373839306162636465666768696a6b6c6d6e6f707172737475767778797a313233343536373839306162636465666768696a6b6c6d6e6f707172737475767778797a313233343536373839306162636465666768696a6b6c6d6e6f707172737475767778797a6d76a914649e41b014a856eb56af9098696e8aaf5904b10388ac0f500000');
end;

procedure TCreateRawTXForm.bTextTX6Click(Sender: TObject);
begin
  LoadhexTX('660600002bdfa85b025cb420782caf458f74cec7b6c2b328f51d2795212664e046c85f4055231638c2010000006b483045022100bbd556ecb5ac6bc00cbc45baa7bdee8c0a072b3eb568f3470d42c9f64c94bc5602204d7e129ac107f114b942b16fe69c15857269f136e3870187234e199b8f274a5b01210342f87717bcb3149baf1e37cb0574afabc85218e28908cd08b76db8f74db8dfc5feffffff8ec686e5ab29ed8a8639c87f096ec8c227f250e16982c77145d0fc085a0c69d4000000006a47304402204cb055263e530d55cffcf1b14536b582752e4946e08a598b43f8c0ecddcf0e2302200cd3a019c41e3cda9e62c38e9674e1dc02d11aadcfccdd326f066bf347aefff7012102d873e50696be65983a1058a92fbc69fbb7763ddf4471ef8da9d52c5f347f9fd1feffffff0264000000000000002c527503747379011e6d086e657756616c75657576a914649e41b014a856eb56af9098696e8aaf5904b10388ac9c3b0f00000000001976a914409ad22f6e29781644fc519b774d155c2981c78588ac0f500000');
end;

procedure TCreateRawTXForm.bTextTX7Click(Sender: TObject);
begin
  LoadhexTX('6606000023f4a85b024d43f11182c7fe7f4531032c423e29de7e323797bcb328fd351db34f20413bfc000000006a4730440220615738ca94c4fddf08080dacad06d09a349687f2809be23addcd937f3e1335050220491c6674cb211b7a23a20c16ca384393b149acbf8a48eb4083e67190289db1d7012102d873e50696be65983a1058a92fbc69fbb7763ddf4471ef8da9d52c5f347f9fd1feffffff94cb5a17e8af0af69357ac08603db5e093da4647bad2a1ef613261ea1c3efdb1000000006a4730440220555cc5d09a3301e4a2aab5ddaf916ba6ecd6ca37b50f856818526d856084bf1b022037d983dcc324cb69c56fdf5496a90404ecc5494567ce8dadd59d917fbd9bd3070121021b3792a976651f438f1d26fcda5b4503638bbefaa4cb12a1e1e5aa6c342cecaefeffffff0218250e00000000001976a9142566568038cf341afe281ee939be3fde27fb430588ac6400000000000000205375037473797576a9149836ed34086a8a029fe0b2ca1e3eaef610d9111788ac1a500000');
end;

procedure TCreateRawTXForm.Button10Click(Sender: TObject);
var s:ansistring;
    CanSelect: Boolean;
begin
  //build pay script to address Edit1.text


 //OP_DUP OP_HASH160 [D3B9B852EB9275882501967255232279EA434257] OP_EQUALVERIFY OP_CHECKSIG
 //compile address
 s:=trim(Edit1.Text);
 try
   s:=base58ToBufCheck(s);
   delete(s,1,1); //remove NetID
 except
   //hex
   s:=hexToBuf(s);
 end;


 s:=opNum('OP_DUP') + opNum('OP_HASH160') + writeScriptData(s) + opNum('OP_EQUALVERIFY') + opNum('OP_CHECKSIG');


 StringGrid2.Cells[2,StringGrid2.Selection.Top]
      := bufToHex(s);

 CanSelect:=true;
 StringGrid2SelectCell(nil,StringGrid2.Selection.Left {aCol}, StringGrid2.Selection.Top{aRow} , CanSelect);
 bRebuild.Click;
end;

function getSriptValFromHumanReadableFormat(s:ansistring;useHR:boolean):ansistring;
begin
  if useHR
      then result:=scriptCompile('`'+trim(s)+'`') //`строка`
      else result:=hexToBuf(s);//hex
end;

procedure TCreateRawTXForm.Button11Click(Sender: TObject);
var res,s:ansistring;
    CanSelect: Boolean;
    //n:word;
begin
  //build delete script + pay script to address Edit1.text
 //OP_NAME_NEW OP_DROP [747374] [0F27] OP_2DROP [747374310A747374320A74737433] OP_DROP OP_DUP OP_HASH160 [1499229323159C6F91E04E7D00AE34B2991E43B7] OP_EQUALVERIFY OP_CHECKSIG
 res:='';

 if CheckBox1.Checked
     then res:=opNum('OP_NAME_NEW')
     else res:=opNum('OP_NAME_UPDATE');

 res:=res + opNum('OP_DROP'); //OP_NAME_NEW OP_DROP

 res:=res + getSriptValFromHumanReadableFormat(Edit5.Text,Checkbox3.Checked); //OP_NAME_NEW OP_DROP [747374]


 {
 !!s:=inttohex(strtoint(Edit8.Text),4);
 if copy(s,1,2)<>'00'
   then s:=hexToBuf(copy(s,3,2)+copy(s,1,2))
   else s:=hexToBuf(copy(s,3,2));
 res:=res + writeScriptData(s); //OP_NAME_NEW OP_DROP [747374] [0F27]
  }
 res:=res + writeScriptIntBuf(strtoint(Edit8.Text));


 res:=res + opNum('OP_2DROP'); //OP_NAME_NEW OP_DROP OP_2DROP



 s:=memo2.Text;
 if Checkbox4.Checked
   then s:=decodeHRtext(trim(s))
   else s:=hexToBuf(trim(s));

 res:=res + writeNameData(s); //OP_NAME_NEW OP_DROP [747374] [747374310A747374320A74737433] OP_DROP


 //ADD ownership script ...
 s:=trim(Edit9.Text);
 try
   s:=base58ToBufCheck(s);
   delete(s,1,1); //remove NetID
 except
   //hex
   s:=hexToBuf(s);
 end;
 res:=res+opNum('OP_DUP') + opNum('OP_HASH160') + writeScriptData(s) + opNum('OP_EQUALVERIFY') + opNum('OP_CHECKSIG');


 StringGrid2.Cells[2,StringGrid2.Selection.Top]
      := bufToHex(res);

 CanSelect:=true;
 StringGrid2SelectCell(nil,StringGrid2.Selection.Left {aCol}, StringGrid2.Selection.Top{aRow} , CanSelect);
 bRebuild.Click;
end;


procedure TCreateRawTXForm.Button12Click(Sender: TObject);
begin
  LoadhexTX('6606000083f5a85b01ea944ea633f5d6f8b8637dbeae9b06e01f22d218f95fc20683c8ecef96b0e741000000006b483045022100c79723dd9918e39a4288c60010db30b1e2ea15f85142e60b43096bf92b98a2c7022052eb97852674672b0fa5569ffd66bb6b70a5b28706f660b1a411e7fe96d75354012102f15c7f323acd8a373c761573d2ac59d5319358e5cab3ab823ead54f7a4f972f7feffffff0234cd0d00000000001976a9143c8d27093ce7cc1d76d979cf01eba3c8c9186ee088ac6400000000000000fdac5251754d00024141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141011e6d4d0802414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414d0802414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414d0802414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414d0802414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414d0802414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414d0802414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414d0802414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414d0802414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414d0802414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414d0802414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414d0802414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414d0802414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414d0802414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414d0802414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414d0802414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414d0802414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414d0802414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414d0802414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414d0802414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414d0802414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414d0802414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414d0802414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414d0802414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414d0802414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414d0802414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414d0802414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414d0802414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414d0802414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414d0802414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414d0802414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414d0802414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414d0802414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414d0802414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414d0802414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414d0802414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414d0802414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414d0802414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414d0802414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414d0802414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414cc841414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141416d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d6d76a914649e41b014a856eb56af9098696e8aaf5904b10388ace64f0000');
end;


procedure TCreateRawTXForm.Button13Click(Sender: TObject);
var res,s:ansistring;
    CanSelect: Boolean;
begin
  //build delete script + pay script to address Edit1.text
 //OP_NAME_DELETE OP_DROP [747379] OP_DROP OP_DUP OP_HASH160 [9836ED34086A8A029FE0B2CA1E3EAEF610D91117] OP_EQUALVERIFY OP_CHECKSIG
 res:='';


 s:=getSriptValFromHumanReadableFormat(Edit10.Text,Checkbox5.Checked);
 res:=opNum('OP_NAME_DELETE') + opNum('OP_DROP')+ s +opNum('OP_DROP');


 //ADD ownership script ... Зачем - непонятно :-)
 s:=trim(Edit11.Text);
 try
   s:=base58ToBufCheck(s);
   delete(s,1,1); //remove NetID
 except
   //hex
   s:=hexToBuf(s);
 end;
 res:=res+opNum('OP_DUP') + opNum('OP_HASH160') + writeScriptData(s) + opNum('OP_EQUALVERIFY') + opNum('OP_CHECKSIG');


 StringGrid2.Cells[2,StringGrid2.Selection.Top]
      := bufToHex(res);

 CanSelect:=true;
 StringGrid2SelectCell(nil,StringGrid2.Selection.Left {aCol}, StringGrid2.Selection.Top{aRow} , CanSelect);
 bRebuild.Click;
end;

procedure TCreateRawTXForm.Button15Click(Sender: TObject);
var Selection:tGridRect;
begin
  StringGrid1.RowCount:=StringGrid1.RowCount+1;
  clearGrid1Row(StringGrid1.RowCount-1);


  Selection:=StringGrid1.Selection;
  Selection.Top:=StringGrid1.RowCount-1;
  Selection.Bottom:=StringGrid1.RowCount-1;
  Selection.Left:=1;
  Selection.Right:=1;
  StringGrid1.Selection:=Selection;

  Button21Click(nil);
  StringGrid1.Cells[0,StringGrid1.RowCount-1]:=inttostr(StringGrid1.RowCount-2);

  bRebuildClick(sender);
end;

procedure TCreateRawTXForm.clearGrid2Row(row:integer);
var i:integer;
begin
  for i:=1 to StringGrid2.ColCount-1 do StringGrid2.Cells[i,row]:='';
end;


procedure TCreateRawTXForm.clearGrid1Row(row:integer);
var i:integer;
begin
  for i:=1 to StringGrid1.ColCount-1 do StringGrid1.Cells[i,row]:='';
end;

procedure TCreateRawTXForm.Button21Click(Sender: TObject);
begin
  StringGrid1.Cells[4,StringGrid1.Selection.Top]:='4294967294';
end;

procedure TCreateRawTXForm.Button23Click(Sender: TObject);
var tx:ttx;
    PrivateKey:ansistring;
    s:ansistring;
    pubKey:TECDSA_Public;
begin


  tx:=unpacktx(hexToBuf(trim(Memo3.text)));

  //function signIn(this:ttx;vin:integer; privKey:PEC_KEY; pubKey:TECDSA_Public; redeemScript:ansistring;hashType:dword; witnessValue:qword=VALUE_UINT64_MAX; witnessScript:ansistring='';keyCompressed:boolean=true):ansistring;

  //Edit14.Text

  s:=trim(Edit14.Text);
  try
    s:=base58ToBufCheck(trim(edit14.text));
    delete(s,1,1);//удаляем сингатуру

    if not (((length(s)=33) and (s[33]=#1)) or (length(s)=32))
       then raise exception.create('wrong private key size');

    if not (((length(s)=33) and (s[33]=#1))) then raise exception.Create('Key must be compressed');

    PrivateKey:=CreatePrivateKeyFromStrBuf(s);
  except
    PrivateKey:=CreatePrivateKeyFromStrBuf(s);
  end;


//!  if s[1]<>hexToBuf( trim(edit12.text))
//!    then raise exception.create('Wrong wif signature. Must be '+bufToHex(hexToBuf( trim(edit12.text)))+' but found '+bufToHex(s[1]));

//function    signTxIn(this:ttx;vin:integer;                privKey:PEC_KEY; pubKey:TECDSA_Public; redeemScript:ansistring;hashType:dword; witnessValue:qword=VALUE_UINT64_MAX; witnessScript:ansistring='';keyCompressed:boolean=true):ansistring;

  {
  Memo1.Lines.Clear();

  Memo1.Lines.Add('HFS='+
    bufToHex(hashForSignature(
     tx//this:ttx;
     ,0 // inIndex:integer;
     ,hexToBuf(trim(Edit10.text))   // prevOutScript:ansistring;
     , 0 or SIGHASH_ALL))
  );
  }

  pubKey.x:='';
  StringGrid1.Cells[3,StringGrid1.Selection.Top]:=
    bufToHex(signTxIn(tx      ,
      StringGrid1.Selection.Top -1 //input No
    , PrivateKey    ) );

  StringGrid1EditingDone(nil);
end;

procedure TCreateRawTXForm.Button24Click(Sender: TObject);
var Selection:tGridRect;
begin
  StringGrid2.RowCount:=StringGrid2.RowCount+1;
  clearGrid2Row(StringGrid2.RowCount-1);


  Selection:=StringGrid2.Selection;
  Selection.Top:=StringGrid2.RowCount-1;
  Selection.Bottom:=StringGrid2.RowCount-1;
  Selection.Left:=1;
  Selection.Right:=1;
  StringGrid2.Selection:=Selection;

  //Button21Click(nil);
  StringGrid2.Cells[0,StringGrid2.RowCount-1]:=inttostr(StringGrid2.RowCount-2);
  StringGrid2.Cells[1,StringGrid2.RowCount-1]:='0';

end;

procedure TCreateRawTXForm.Button25Click(Sender: TObject);
begin
 if StringGrid2.RowCount>2 then
    StringGrid2.RowCount:=StringGrid2.RowCount-1
 else clearGrid2Row(StringGrid2.RowCount-1);

end;

procedure TCreateRawTXForm.Button26Click(Sender: TObject);
begin
  //LoadhexTX('02000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000FEFFFFFF0100000000000000001976A914000000000000000000000000000000000000000088AC00000000');
 LoadhexTX('02000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000FEFFFFFF0100000000000000001976A914000000000000000000000000000000000000000088AC00000000');
end;

procedure TCreateRawTXForm.Button27Click(Sender: TObject);
var s,tx:ansistring;
var json:TJSONObject;
    ja,ja1:TJSONArray;
    i,j:integer;
begin

 s:=trim(Memo3.Text);

 if emerAPI<>nil then begin
   //  blockChain.sendQueryAsync('getrawtransaction',['"'+eTxID.Text+'"'],@AsyncAddressInfoDone);
   //['"'+s+'"']

   emerAPI.EmerAPIConnetor.sendWalletQueryAsync('sendrawtransaction',getJSON('{hexstring:"'+s+'"}'),@AsyncAddressInfoDone,'sendTX');


 end else begin
      s:=getEmerRPCAnswer(
        //'query { gettransaction(txid:'+txr[i]+',includeWatchonly:true) { answer }}'
        'query { sendrawtransaction (hexstring:"'+s+'") { answer }}'
      );


      if s='' then begin
        //Memo1.Lines.Append('Error obtaining tx info');
        raise exception.Create('Error obtaining sending transaction');
      end;

      json := TJSONObject(GetJSON(changeNone(changeQuotes(s))));
      //memo2.Text:=TJSONObject(json.Elements['result']).Elements['hex'].asString;
 end;

end;

procedure TCreateRawTXForm.Button28Click(Sender: TObject);
var
    PrivateKey:ansistring;
    s:ansistring;
    pubKey:TECDSA_Public;
        i:integer;

begin

  s:=trim(Edit14.Text);
  try
    s:=base58ToBufCheck(s);
    delete(s,1,1);//удаляем сингатуру

    if not (((length(s)=33) and (s[33]=#1)) or (length(s)=32))
       then raise exception.create('wrong private key size');

    if not (((length(s)=33) and (s[33]=#1))) then raise exception.Create('Key must be compressed');

    PrivateKey:=CreatePrivateKeyFromStrBuf(s);
  except
    PrivateKey:=CreatePrivateKeyFromStrBuf(s);
  end;


  //check for pubKey
  pubkey:=GetPublicKey(PrivateKey);

 if length(addId)>0 then Edit7.Text:=publicKey2Address(pubkey,addId[1],true)
 else raise exception.Create('Select NetID');


end;

procedure TCreateRawTXForm.Button29Click(Sender: TObject);
var tx:ttx;
    PrivateKey:ansistring;
    s:ansistring;
    pubKey:TECDSA_Public;
begin


  tx:=unpacktx(hexToBuf(trim(Memo3.text)));

  //function signIn(this:ttx;vin:integer; privKey:PEC_KEY; pubKey:TECDSA_Public; redeemScript:ansistring;hashType:dword; witnessValue:qword=VALUE_UINT64_MAX; witnessScript:ansistring='';keyCompressed:boolean=true):ansistring;

  //Edit14.Text

  s:=trim(Edit14.Text);
  try
    s:=base58ToBufCheck(trim(edit14.text));
    delete(s,1,1);//удаляем сингатуру

    if not (((length(s)=33) and (s[33]=#1)) or (length(s)=32))
       then raise exception.create('wrong private key size');

    if not (((length(s)=33) and (s[33]=#1))) then raise exception.Create('Key must be compressed');

    PrivateKey:=CreatePrivateKeyFromStrBuf(s);
  except
    PrivateKey:=CreatePrivateKeyFromStrBuf(s);
  end;


//!  if s[1]<>hexToBuf( trim(edit12.text))
//!    then raise exception.create('Wrong wif signature. Must be '+bufToHex(hexToBuf( trim(edit12.text)))+' but found '+bufToHex(s[1]));

//function    signTxIn(this:ttx;vin:integer;                privKey:PEC_KEY; pubKey:TECDSA_Public; redeemScript:ansistring;hashType:dword; witnessValue:qword=VALUE_UINT64_MAX; witnessScript:ansistring='';keyCompressed:boolean=true):ansistring;

  {
  Memo1.Lines.Clear();

  Memo1.Lines.Add('HFS='+
    bufToHex(hashForSignature(
     tx//this:ttx;
     ,0 // inIndex:integer;
     ,hexToBuf(trim(Edit10.text))   // prevOutScript:ansistring;
     , 0 or SIGHASH_ALL))
  );
  }

  pubKey.x:='';
  StringGrid1.Cells[3,StringGrid1.Selection.Top]:=
    bufToHex(signTxIn(tx      ,
      StringGrid1.Selection.Top -1 //input No
    , PrivateKey   ,@pubkey, hexToBuf(trim(Edit15.Text)) ) );

  StringGrid1EditingDone(nil);
end;

procedure TCreateRawTXForm.Button30Click(Sender: TObject);
var i,n:integer;
begin

 for n:=StringGrid1.Selection.Top to StringGrid1.RowCount-2 do
   for i:=0 to StringGrid1.ColCount-1 do
      StringGrid1.Cells[i,n]:=StringGrid1.Cells[i,n+1];

 for i:=0 to StringGrid1.RowCount-2 do
   StringGrid1.Cells[0,i+1]:=inttostr(i);


 Button16.Click;

end;

procedure TCreateRawTXForm.Button31Click(Sender: TObject);
begin
  //createmultisig 2 "[\"023B17B22635E9738AE2CD1EB9C7A85EE9A3ED03FE614ED26AF7D28A8FD2820EF5\",\"03FDF4907810A9F5D9462A1AE09FEEE5AB205D32798B0FFCC379442021F84C5BBF\",\"039EBD374EEA3BEFDDF46BBB182E291FB719EE1B705B0B7802161038EB7DA8A036\"]"
  //mp: 2Tng(hd) 1 2
 {
  "address": "2N92Ne8HWCUY87MbuX4c8gmGQ3dWamnWMwc",
  "redeemScript": "5221023b17b22635e9738ae2cd1eb9c7a85ee9a3ed03fe614ed26af7d28a8fd2820ef52103fdf4907810a9f5d9462a1ae09feee5ab205d32798b0ffcc379442021f84c5bbf21039ebd374eea3befddf46bbb182e291fb719ee1b705b0b7802161038eb7da8a03653ae"
 }
 //send to ms 7833f305c180cbf56a95948e416cf00e8f192d46941900f6f1c15f4e05622d74
 //02000000835F345C02B991F547C7ED78B2DCBB32207BDE8B575540AC9E43B873714EC3BD28C8B86E06010000006A47304402206AC6EFE46BD00044FE76F76A7A1DE003A797B7BBA0574E8336AD45B730EC063702203A0B9F3D4F19E94E6A9254E0422B30E39CDEE777C9A6198CD63D3CE30C5EA332012102D873E50696BE65983A1058A92FBC69FBB7763DDF4471EF8DA9D52C5F347F9FD1FEFFFFFFDC3D107F6F1AE5F457FA428984B41761E8C4CD80A8A46D56B0B56DCD9D6AC4E8010000006B483045022100966A282473C9F99A9FD88F2D545E7803B9D0985FAA0E6D13C05149CFE09488B702205C40D81485762FBEF29B433FAB18803B364ED6E6E25C32DDCA0B9E67783279F701210205F66743FDC18B87516C8FAE49CBCB62E311E79C2C51F40A8980F68A32DB8C85FEFFFFFF0240420F000000000017A914AD13D3E70602D0AB5118D1C18C53B0DF41603CD08720030000000000001976A914D72C113003F2337FFF9A6D4955F6F0BD6BECF7F088AC0A960000


 //name2ms 10f6563551b629ea098b14b8e9b24f3da9470bd1ea2b3a92d685b36473c67fa2
 //66060000D660345C0180B6E0628F10A63BC6096CE4CB9A522CBBDBF699AA081D1CF94C592E7F8E0354010000006B483045022100BA4CAAB6A1BA8BBD4FB035CB6E133A72FEAC9CF4EF48D0E2A109E15D4BEE999B0220059EF811D645D906191B39312237562B67B884C4E35BA52491B90B6F71293D17012103EF5A04F0B04031E876C2943DC12401896A030E039F284F0E5BCEE6E0B25D72EDFEFFFFFF02E8E10D00000000001976A9142A579FA820560BD1B96AFAF4C50D2750D353E55C88AC6400000000000000325175036D733102B80B6D0F6D756C7469736967206E616D65203175A914AD13D3E70602D0AB5118D1C18C53B0DF41603CD0870B960000

 LoadhexTX('02000000835F345C02B991F547C7ED78B2DCBB32207BDE8B575540AC9E43B873714EC3BD28C8B86E06010000006A47304402206AC6EFE46BD00044FE76F76A7A1DE003A797B7BBA0574E8336AD45B730EC063702203A0B9F3D4F19E94E6A9254E0422B30E39CDEE777C9A6198CD63D3CE30C5EA332012102D873E50696BE65983A1058A92FBC69FBB7763DDF4471EF8DA9D52C5F347F9FD1FEFFFFFFDC3D107F6F1AE5F457FA428984B41761E8C4CD80A8A46D56B0B56DCD9D6AC4E8010000006B483045022100966A282473C9F99A9FD88F2D545E7803B9D0985FAA0E6D13C05149CFE09488B702205C40D81485762FBEF29B433FAB18803B364ED6E6E25C32DDCA0B9E67783279F701210205F66743FDC18B87516C8FAE49CBCB62E311E79C2C51F40A8980F68A32DB8C85FEFFFFFF0240420F000000000017A914AD13D3E70602D0AB5118D1C18C53B0DF41603CD08720030000000000001976A914D72C113003F2337FFF9A6D4955F6F0BD6BECF7F088AC0A960000');
end;

procedure TCreateRawTXForm.Button32Click(Sender: TObject);
begin
 LoadhexTX('66060000D660345C0180B6E0628F10A63BC6096CE4CB9A522CBBDBF699AA081D1CF94C592E7F8E0354010000006B483045022100BA4CAAB6A1BA8BBD4FB035CB6E133A72FEAC9CF4EF48D0E2A109E15D4BEE999B0220059EF811D645D906191B39312237562B67B884C4E35BA52491B90B6F71293D17012103EF5A04F0B04031E876C2943DC12401896A030E039F284F0E5BCEE6E0B25D72EDFEFFFFFF02E8E10D00000000001976A9142A579FA820560BD1B96AFAF4C50D2750D353E55C88AC6400000000000000325175036D733102B80B6D0F6D756C7469736967206E616D65203175A914AD13D3E70602D0AB5118D1C18C53B0DF41603CD0870B960000');
end;

procedure TCreateRawTXForm.Button33Click(Sender: TObject);
begin
 //OP_FALSE <sig> { OP_1 <pubkey> OP_1 OP_CHECKMULTISIG }
 //from btc; 11111111 added
 LoadhexTX('02000000111111110001018b39f13259e961248f924d64cc9fbece50b33cec12167e204238872214ff2f700000000000fdffffff01c84f10000000000016001410b74462e409e8fafb117ecb44cf797cf89fc7bf040047304402202bf1661f8b0728ca1405de366674d691633d85929231f9f8b316d1c40c7475a1022004e3c619de89014d1dafea73c8f81f76b26eed09125aea4bf2cd1752da2747160147304402202a8f8e0448f42e9d2d8fcc7d9ed33af215f27abd81ba7758a251b20b7fa7c32d0220712e44eb2e5bd786ab6fb6e5377263f4681000cbd6e994036a87d3d2f51adbd801695221030030f8b96f11da696e5d1cbfb13b7bf1055dee22e7eee523179a192446f6d77121022fd014adef186d4e1a3df09146d9fc0da653fba5d42ae31233aa388be9e53fac21027c0a88252ac7b4345b7351e3daccf1965da3ea214fda6fa6ecceb5c45a5986e453ae00000000');

 //sign it:
 //0[] PUSHDATA(72)[3045022100ad0851c69dd756b45190b5a8e97cb4ac3c2b0fa2f2aae23aed6ca97ab33bf88302200b248593abc1259512793e7dea61036c601775ebb23640a0120b0dba2c34b79001] PUSHDATA(69)[5141042f90074d7a5bf30c72cf3a8dfd1381bdbd30407010e878f3a11269d5f74a58788505cdca22ea6eab7cfb40dc0e07aba200424ab0d79122a653ad0c7ec9896bdf51ae]

 // https://github.com/libbitcoin/libbitcoin-system/wiki/P2SH(P2WSH)-Transactions


end;

procedure TCreateRawTXForm.Button34Click(Sender: TObject);
begin
  LoadhexTX('0100000011111111000101708256c5896fb3f00ef37601f8e30c5b460dbcd1fca1cd7199f9b56fc4ecd5400000000023220020615ae01ed1bc1ffaad54da31d7805d0bb55b52dfd3941114330368c1bbf69b4cffffffff01603edb0300000000160014bbef244bcad13cffb68b5cef3017c7423675552204004730440220010d2854b86b90b7c33661ca25f9d9f15c24b88c5c4992630f77ff004b998fb802204106fc3ec8481fa98e07b7e78809ac91b6ccaf60bf4d3f729c5a75899bb664a501473044022046d66321c6766abcb1366a793f9bfd0e11e0b080354f18188588961ea76c5ad002207262381a0661d66f5c39825202524c45f29d500c6476176cd910b1691176858701695221026ccfb8061f235cc110697c0bfb3afb99d82c886672f6b9b5393b25a434c0cbf32103befa190c0c22e2f53720b1be9476dcf11917da4665c44c9c71c3a2d28a933c352102be46dc245f58085743b1cc37c82f0d63a960efa43b5336534275fc469b49f4ac53ae00000000');
end;


procedure TCreateRawTXForm.Button20Click(Sender: TObject);
var i:integer;
    n:qword;
begin
  n:=0;
  for i:=1 to StringGrid1.RowCount-1 do
    if trim(StringGrid1.Cells[6,i])<>'' then
      n:=n+strtoint64(trim(StringGrid1.Cells[6,i]));
  Edit13.Text:=inttostr(n);
end;


procedure TCreateRawTXForm.bcUpdated(sender:tObject);
var js,e:tJsonData;
    s:string;
    val,x:double;
    nc,i,n:integer;
    st:ansistring;
    vR,vY,vS:double;
    nameScript:tNameScript;
    amount:integer;
begin
 amount:=EmerAPI.blockChain.MIN_TX_FEE;

 for i:=1 to StringGrid2.RowCount-1 do begin
   nameScript:=nameScriptDecode(hexToBuf(trim(StringGrid2.Cells[2,i])));
   if nameScript.TXtype in [#$51,#$52] then begin
     amount:=EmerAPI.blockChain.getNameOpFee(NameScript.Days,NameScript.TXtype,length(NameScript.Name)+length(NameScript.Value));
     break;
   end;
 end;

 Edit12.Text:=intToStr(
    amount
   );
end;

procedure TCreateRawTXForm.AsyncAddressInfoDone(sender:TEmerAPIBlockchainThread;result:tJsonData);
var js,e:tJsonData;
    s:string;
    val,x:double;
    nc,i,n:integer;
    st:ansistring;
    vR,vY,vS:double;
    nameScript:tNameScript;
    amount:integer;

begin


 if result=nil then begin
   showMessageSafe('Error: '+sender.lastError);
   exit;
 end;

 if sender.id='loadTX' then begin

   if result<>nil then begin
     e:=result.FindPath('result');
     if e<>nil then
        try
          if e.AsString<>'' then LoadhexTX(e.AsString)
          else Edit6.Text:='Error: empty result';
        except
          Edit6.Text:='Error: incorrect result in: '+result.AsJSON;
        end
     else Edit6.Text:='Error: can''t find result in: '+result.AsJSON;
   end else Edit6.Text:='Error: empty result';


 end else
 if sender.id='fillUTXO' then begin
   e:=result.FindPath('result.unspents');

   //showMessageSafe('XXX: '+sender.lastError);
   // exit;

   if e<>nil then begin
     nc:=0;
     val:=0;
     n:=0;

     for i:=0 to TJSONArray(e).Count-1 do begin
       st:=e.Items[i].FindPath('scriptPubKey').AsString;
       if length(st)=0 then continue;
       if not ((copy(st,1,2)='51') or (copy(st,1,2)='52') or (copy(st,1,2)='51')) then begin
         x:=myStrToFloat(e.Items[i].FindPath('amount').AsString);

         if n>0 then Button15.Click; //add row
         n:=n+1;

         StringGrid1.Cells[0,n]:=inttostr(n-1);
         StringGrid1.Cells[1,n]:=bufToHex(reverse(hexToBuf(e.Items[i].FindPath('txid').AsString)));  // bufToHex(tx.ins[i].hash);
         StringGrid1.Cells[2,n]:=e.Items[i].FindPath('vout').AsString;//inttostr(tx.ins[i].index);

         StringGrid1.Cells[3,n]:=e.Items[i].FindPath('scriptPubKey').AsString; //bufToHex(tx.ins[i].script);
         //StringGrid1.Cells[4,i+1]:=inttostr(tx.ins[i].sequence);
         {
         if length(tx.ins[i].witness)>0 then begin
           StringGrid1.Cells[5,i+1]:='';
           for j:=0 to length(tx.ins[i].witness) -1 do
             StringGrid1.Cells[5,i+1]:=StringGrid1.Cells[5,i+1] + bufToHex(tx.ins[i].witness[j]) + ' ';
           StringGrid1.Cells[5,i+1]:=trim(StringGrid1.Cells[5,i+1]);
         end else StringGrid1.Cells[5,i+1]:='';
         } StringGrid1.Cells[5,n]:='';
         StringGrid1.Cells[4,n]:='4294967294';


         StringGrid1.Cells[6,n]:=inttostr(trunc(myStrToFloat(e.Items[i].FindPath('amount').AsString)*1000000));
         //StringGrid1.Cells[7,i+1]:=decodeInScript(tx.ins[i].script,addID);
         StringGrid1.Cells[7,n]:='NOT SIGNED (scriptPubKey)';

         //val:=val+x; посчитаем в  button20.Click;
       end;
     end;

     //eBalance.Text:=myFloatToStr(val);
     //eNamesCount.Text:=intToStr(nc);

   end else
     showMessageSafe('Error: can''t find a result in '+result.asJson);

   button20.Click;


 end else if sender.id='sendTX' then begin
   showMessageSafe('TX send: '+result.asJson);

 end else if sender.id='fillFee' then begin
   //edit12.Text:='WAIT...';

   //blockChain.sendQueryAsync('getblockchaininfo',[],@AsyncAddressInfoDone,'fillFee');: .difficulty

   //Reward = 5020 / sqrt(sqrt(difficulty))

   //p = [ sqrt(0.0005 * R * y) + s / 128 ] /100

   //R = Current Proof-of-work reward, in cents (EMc).
   //y = Lease time, in years. Available by 1 day fractions.
   //s = key value size, in bytes. Division is integer, so for entries, less than 128 bytes, this price part is zero.
   //The cost of creating a new name is equal to the cost of a 1 year lease.

   //So if you wanted to lease a name (length 100 bytes) for 1 year, you would have paid 0.044EMC:
   //p = sqrt(0.0005 * 14000 * (1[create new name] + 1[one year lease])) + (floor)(100 / 128) = 4.4EMc = 0.044EMC





   //emerAPI.GetNameOpFee(nRentalDays:integer;op:char;txtLen:integer;BlockIndex:integer=0):dword;
//   edit12.Text:= inttostr(emerAPI.blockChain.GetNameOpFee(nameScript.Days,ord(nameScript.TXtype),length(nameScript.Value) + length(nameScript.Name)));
  {
   amount:=EmerAPI.blockChain.MIN_TX_FEE;

   for i:=1 to StringGrid2.RowCount-1 do begin
     nameScript:=nameScriptDecode(hexToBuf(trim(StringGrid2.Cells[2,i])));
     if nameScript.TXtype in [#$51,#$52] then begin
       amount:=EmerAPI.blockChain.getNameOpFee(NameScript.Days,NameScript.TXtype,length(NameScript.Name)+length(NameScript.Value));
       break;
     end;
   end;

   Edit12.Text:=intToStr(
      amount
     );
   }

 end else
   showMessageSafe('Unknown Blockchain response: '+result.asJson);

end;



procedure TCreateRawTXForm.Button17Click(Sender: TObject);
var s,tx:ansistring;
var json:TJSONObject;
    ja,ja1:TJSONArray;
    i,j:integer;
begin

 s:=trim(Edit7.Text);

 emerAPI.EmerAPIConnetor.sendWalletQueryAsync('scantxoutset',
    //['start','[{"address" : "'+s+'" }]']
    //scantxoutset
    GetJSON('{action:"start", "scanobjects":[{"address":"'+s+'"}]}')
 ,@AsyncAddressInfoDone,'fillUTXO');

 StringGrid1.RowCount:=2;
 clearGrid1Row(1);



end;

procedure TCreateRawTXForm.BitBtn1Click(Sender: TObject);
begin
  LoadhexTX('010000008d2d825b0001010000000000000000000000000000000000000000000000000000000000000000ffffffff05022b3b0103ffffffff02c05f75ba000000002321036ec5b9ef8e612025e6a141c8d7005e56093d9b2d4767b20f2d3ea9cc441541d6ac0000000000000000266a24aa21a9ede2f61c3f71d1defd3fa999dfa36953755c690689799962b48bebd836974e8cf90120000000000000000000000000000000000000000000000000000000000000000000000000');
  {
  tx sig    time     witn vilen   tx hash                                                           index   len sign                                                                                                                                               seq      vOutLen  value            script                                                                     value            script                                                                          lock     witness
  01000000  8d2d825b 0001 01      0000000000000000000000000000000000000000000000000000000000000000  ffffffff 05  022b3b0103                                                                                                                                        ffffffff 02       c05f75ba00000000 23 21036ec5b9ef8e612025e6a141c8d7005e56093d9b2d4767b20f2d3ea9cc441541d6ac  0000000000000000 26 6a24aa21a9ede2f61c3f71d1defd3fa999dfa36953755c690689799962b48bebd836974e8cf9 01200000 00000000000000000000000000000000000000000000000000000000000000000000
  01000000  CDC7835B      01      807033E083225B87CEBBC779FE59210887F8D06542834D45C4A04AE658121874  00000000 48  47304402201021AACF3A0A80E067775FC0CFDC68B2631D22EE24E98D1EF9D6FDFA3ED0FE0402200BED96E7316D7BEE6EF1EA8A4CCF219A914CB2D3BED72C05EF7FCEE1BE7F43F701  FEFFFFFF 02       005ED0B200000000 19 76A914649E41B014A856EB56AF9098696E8AAF5904B10388AC                      5C01A50700000000 19 76A9147E3BE20EB65C742A97EF6848E7FAB8D2FE50E0C188AC                           213C0000

  script 0 : 21036EC5B9EF8E612025E6A141C8D7005E56093D9B2D4767B20F2D3EA9CC441541D6AC
  value = 3128254400 = 3k emc
  		  [036EC5B9EF8E612025E6A141C8D7005E56093D9B2D4767B20F2D3EA9CC441541D6] OP_CHECKSIG

  выход 1: OP_RETURN [AA21A9EDE2F61C3F71D1DEFD3FA999DFA36953755C690689799962B48BEBD836974E8CF9]

  }
end;

procedure TCreateRawTXForm.Button18Click(Sender: TObject);
var i:integer;
    x:integer;
begin
  x:=strToInt(Edit13.Text);
  x:=x-strToInt(Edit12.Text);

  for i:=0 to StringGrid2.RowCount-2 do
    if StringGrid2.Cells[1,i+1]<>'' then x:=x-strToInt(StringGrid2.Cells[1,i+1]);

  if StringGrid2.Cells[1,StringGrid2.Selection.Top]<>'' then
     StringGrid2.Cells[1,StringGrid2.Selection.Top]:= inttostr(strToInt(StringGrid2.Cells[1,StringGrid2.Selection.Top])+ x);
end;

procedure TCreateRawTXForm.Button19Click(Sender: TObject);
begin




  edit12.Text:='WAIT...';

  //emerAPI.EmerAPIConnetor.sendWalletQueryAsync('getblockchaininfo',nil,@AsyncAddressInfoDone,'fillFee');

  emerAPI.blockChain.update(EmerAPINotification(@bcUpdated,'update',false));


  //p = [ sqrt(0.0005 * R * y) + s / 128 ] /100

  //R = Current Proof-of-work reward, in cents (EMc).
  //y = Lease time, in years. Available by 1 day fractions.
  //s = key value size, in bytes. Division is integer, so for entries, less than 128 bytes, this price part is zero.
  //The cost of creating a new name is equal to the cost of a 1 year lease.

  //So if you wanted to lease a name (length 100 bytes) for 1 year, you would have paid 0.044EMC:
  //p = sqrt(0.0005 * 14000 * (1[create new name] + 1[one year lease])) + (floor)(100 / 128) = 4.4EMc = 0.044EMC



end;

procedure TCreateRawTXForm.Button16Click(Sender: TObject);

begin
 if StringGrid1.RowCount>2 then
    StringGrid1.RowCount:=StringGrid1.RowCount-1
 else clearGrid1Row(StringGrid1.RowCount-1);

 Button20Click(nil);
 bRebuildClick(sender);
end;

procedure TCreateRawTXForm.Button1Click(Sender: TObject);
begin
  Edit2.Text:='1';
end;

procedure TCreateRawTXForm.Button22Click(Sender: TObject);
begin
  clearGrid1Row(StringGrid1.Selection.Top);
end;

procedure TCreateRawTXForm.Button2Click(Sender: TObject);
begin
    Edit2.Text:='2';
end;

procedure TCreateRawTXForm.Button3Click(Sender: TObject);
begin
    Edit2.Text:=inttostr($666);
end;

procedure TCreateRawTXForm.Button4Click(Sender: TObject);
begin
  Edit3.Text:=inttostr(winTimeToUnixTime(nowUTC()));
end;

procedure TCreateRawTXForm.Button5Click(Sender: TObject);
begin
  Edit4.Text:=inttostr(winTimeToUnixTime(nowUTC()));
end;

procedure TCreateRawTXForm.Button6Click(Sender: TObject);
begin
  Edit4.Text:='0';
end;

procedure TCreateRawTXForm.Button7Click(Sender: TObject);
var CanSelect:boolean;
begin


  StringGrid2.Cells[2,StringGrid2.Selection.Top]
     := bufToHex(scriptCompile(trim(Memo1.Text)));

  CanSelect:=true;
  StringGrid2SelectCell(nil,StringGrid2.Selection.Left {aCol}, StringGrid2.Selection.Top{aRow} , CanSelect);
  bRebuild.Click;

end;

procedure TCreateRawTXForm.Button8Click(Sender: TObject);
begin

 if false and (Form4<> nil) then begin
   Form4.Edit1.Text:=Edit6.text;
   if not Form4.Visible then Form4.show;
   Form4.Button1.Click;
   Form4.Button2.Click;
 end else begin
   if emerAPI=nil then exit;
   emerAPI.EmerAPIConnetor.sendWalletQueryAsync('getrawtransaction',GetJSON('{"txid":"'+trim(Edit6.Text)+'"}'),@AsyncAddressInfoDone,'loadTX');
   Edit6.Text:='please wait...';
 end;

end;

procedure TCreateRawTXForm.Button9Click(Sender: TObject);
begin

 //Edit6.text:=bufToHex(reverse(hexToBuf(StringGrid1.Cells[1,aRow])));
 StringGrid1.Cells[1,StringGrid1.Selection.Top]
      := bufToHex(reverse(hexToBuf(trim(Edit6.text))));
end;

procedure TCreateRawTXForm.Edit2Change(Sender: TObject);
begin
  if bRebuild.Enabled then bRebuild.Click;
end;

procedure TCreateRawTXForm.Edit3Change(Sender: TObject);
begin
  if bRebuild.Enabled then bRebuild.Click;
end;

procedure TCreateRawTXForm.Edit4Change(Sender: TObject);
begin
  if bRebuild.Enabled then bRebuild.Click;
end;

procedure TCreateRawTXForm.LoadbinTX(txbin:ansistring);
var
    tx:ttx;
    i,j:integer;


begin
  //unpack tx

 bRebuild.Enabled:=false;
 try

  tx:=unpacktx(txbin);


  edit2.Text:=inttostr(tx.version);
  edit3.Text:=inttostr(tx.time);
  edit4.Text:=inttostr(tx.locktime);




  StringGrid1.RowCount:=length(tx.ins)+1;

  for i:=0 to length(tx.ins)-1 do begin
    StringGrid1.Cells[0,i+1]:=inttostr(i);
    StringGrid1.Cells[1,i+1]:=bufToHex(tx.ins[i].hash);
    StringGrid1.Cells[2,i+1]:=inttostr(tx.ins[i].index);
    StringGrid1.Cells[3,i+1]:=bufToHex(tx.ins[i].script);
    StringGrid1.Cells[4,i+1]:=inttostr(tx.ins[i].sequence);

    if length(tx.ins[i].witness)>0 then begin
      StringGrid1.Cells[5,i+1]:='';
      for j:=0 to length(tx.ins[i].witness) -1 do
        StringGrid1.Cells[5,i+1]:=StringGrid1.Cells[5,i+1] + bufToHex(tx.ins[i].witness[j]) + ' ';
      StringGrid1.Cells[5,i+1]:=trim(StringGrid1.Cells[5,i+1]);
    end else StringGrid1.Cells[5,i+1]:='';

    StringGrid1.Cells[6,i+1]:='';

    //if '#00#00#00#00#00#00#00#00#00#00#00#00#00#00#00#00#00#00#00#00#00#00#00#00#00#00#00#00#00#00#00#00'
    if tx.ins[i].hash=#00#00#00#00#00#00#00#00#00#00#00#00#00#00#00#00#00#00#00#00#00#00#00#00#00#00#00#00#00#00#00#00
       then  StringGrid1.Cells[7,i+1]:='mining tx'
       else   StringGrid1.Cells[7,i+1]:=decodeInScript(tx.ins[i].script,addID);

    if trim(tx.ins[i].script)<>'' then
    if checkSignatureForTX(tx.ins[i].script,tx,i) then
      StringGrid1.Cells[7,i+1]:='(correct) ' + StringGrid1.Cells[7,i+1]
    else
      StringGrid1.Cells[7,i+1]:='(WRONG) ' + StringGrid1.Cells[7,i+1];

  end;


  StringGrid2.RowCount:=length(tx.outs)+1;


  for i:=0 to length(tx.outs)-1 do begin
    StringGrid2.Cells[0,i+1]:=inttostr(i);
    StringGrid2.Cells[1,i+1]:=inttostr(tx.outs[i].value);
    StringGrid2.Cells[2,i+1]:=bufToHex(tx.outs[i].script);
    StringGrid2.Cells[3,i+1]:=scriptExplain(tx.outs[i].script,addId);
  end;

  Memo1.Text:='';
  Edit6.Text:='';
  showScriptData('');

  Button20.Click();

  finally
    bRebuild.Enabled:=true;
  end;

  try
    bRebuild.Click;

  except
    on e:exception do
      Memo3.Text:=e.message;
  end;
end;

procedure TCreateRawTXForm.bLoadTXClick(Sender: TObject);
var s:ansistring;
begin
  s:=askUserForTX();
  if s<>'' then LoadbinTX(s);
end;

procedure TCreateRawTXForm.bTextTXClick(Sender: TObject);
begin
  LoadhexTX('01000000cdc7835b01807033e083225b87cebbc779fe59210887f8d06542834d45c4a04ae658121874000000004847304402201021aacf3a0a80e067775fc0cfdc68b2631d22ee24e98d1ef9d6fdfa3ed0fe0402200bed96e7316d7bee6ef1ea8a4ccf219a914cb2d3bed72c05ef7fcee1be7f43f701feffffff02005ed0b2000000001976a914649e41b014a856eb56af9098696e8aaf5904b10388ac5c01a507000000001976a9147e3be20eb65c742a97ef6848e7fab8d2fe50e0c188ac213c0000');
end;

procedure TCreateRawTXForm.StringGrid1EditingDone(Sender: TObject);
begin
  bRebuild.Click;
  if trim(StringGrid1.Cells[3,StringGrid1.Selection.Top])<>''
         then
           if StringGrid1.Cells[1,StringGrid1.Selection.Top]<>'0000000000000000000000000000000000000000000000000000000000000000'
              then StringGrid1.Cells[7,StringGrid1.Selection.Top]:=decodeInScript(hexToBuf(trim(StringGrid1.Cells[3,StringGrid1.Selection.Top])),addID)
              else StringGrid1.Cells[7,StringGrid1.Selection.Top]:='mining tx'
         else StringGrid1.Cells[7,StringGrid1.Selection.Top]:='';
end;

procedure TCreateRawTXForm.StringGrid1SelectCell(Sender: TObject; aCol,
  aRow: Integer; var CanSelect: Boolean);
begin
  Edit6.text:=bufToHex(reverse(hexToBuf(StringGrid1.Cells[1,aRow])));


 if pos('NOT SIGNED (scriptPubKey)',StringGrid1.Cells[7,aRow])=1
   then Edit15.Text:=StringGrid1.Cells[3,aRow];

end;

procedure TCreateRawTXForm.StringGrid2EditingDone(Sender: TObject);
begin
  bRebuild.Click;
end;

procedure TCreateRawTXForm.showScriptData(buf:ansistring);
var //i,n,c:integer;
    l:tStringList;
    add:ansistring;
    i:integer;

    function uq(s:ansistring;checkbox:tCheckBox):ansistring;
    begin
      if length(s)<1 then begin
        checkbox.Checked:=false;
        result:='';
      end else
        if (s[1]='`') and (s[length(s)]='`') then begin
           result:=copy(s,2,length(s)-2);
           checkbox.checked:=true;
        end else begin
           result:=s;
           checkbox.checked:=false;
        end;
    end;
  var
   s:ansistring;
begin
 //1 5789
 Edit1.Text:='';
 Edit5.Text:='';
 Memo2.Text:='';
 Edit8.Text:='';
 Edit9.Text:='';
 Edit10.Text:='';
 Edit11.Text:='';
 checkbox1.Checked:=false;
 PageControl1.TabIndex:=3;
 if length(buf)<4 then exit;


 l:=scriptParseToList(buf);

 if l.Count<5 then exit;

 try
   //OP_DUP OP_HASH160 <address> OP_EQUALVERIFY OP_CHECKSIG
    add:='';

   //memo3.Text:='l[l.Count-5]= '+bufToHex(l[l.Count-5])+'; opNum(''OP_DUP'')='+ bufToHex(opNum('OP_DUP'));
   //memo3.Lines.Append('l.Count='+inttostr(l.Count));

   if {(l.Count>=5) and} (l[l.Count-5]=opNum('OP_DUP')) and (l[l.Count-4]=opNum('OP_HASH160')) and (l[l.Count-2]=opNum('OP_EQUALVERIFY')) and (l[l.Count-1]=opNum('OP_CHECKSIG')) then begin
     //checking tail
     add:=l[l.Count - 3];
     if (length(add)=20) and (l.Objects[l.Count - 3]=nil) then
       if length(addId)>0 then
          add:=buf2Base58Check(addId[1]+add)
        else
          add:=bufToHex(add)
     else add:='';//incorrect address
   end;

   if add='' then exit; //

   for i:=1 to 5 do l.Delete(l.Count-1);

   if (l.Count=0) then begin
     edit1.Text:=add;
     PageControl1.TabIndex:=0;
   end else if (l.Count>6) and ((l[0]=opNum('OP_NAME_NEW')) or (l[0]=opNum('OP_NAME_UPDATE')))
    {
      0 OP_NAME_NEW
      1 OP_DROP
      2 [name]
      3 [days]
      4 OP_2DROP
      5 [value]
      6 .... OP_2DROP OP_DROP only
     }

      and (l[1]=opNum('OP_DROP'))
      and (l.Objects[2]=nil)
      and (l.Objects[3]=nil)
      and (l[4]=opNum('OP_2DROP'))
      and (l.Objects[5]=nil)
      //and ((l[6]=opNum('OP_2DROP')) or (l[6]=opNum('OP_DROP')))
   then begin
   //   OP_NAME_NEW OP_DROP [747374] [0F27] OP_2DROP [747374310A747374320A74737433] OP_DROP                       OP_DUP OP_HASH160 <mhPsFuD6srgjVXMR2VdP45tpco3C5GStst> OP_EQUALVERIFY OP_CHECKSIG
  //    OP_NAME_NEW OP_DROP []       []     OP_2DROP OP_PUSHDATA2 [len] [data] OP_PUSHDATA2 [len] [data] OP_2DROP OP_DUP OP_HASH160 [649E41B014A856EB56AF9098696E8AAF5904B103] OP_EQUALVERIFY OP_CHECKSIG
  //Name: "tst" for 9999 days  value="tst1tst2tst3"  owner: <mhPsFuD6srgjVXMR2VdP45tpco3C5GStst>
  // длинное имя

   //  OP_NAME_NEW OP_DROP [name] [days] OP_2DROP [value] OP_DROP OP_DUP OP_HASH160 <address> OP_EQUALVERIFY OP_CHECKSIG
   //  OP_NAME_NEW OP_DROP [name] [days] OP_2DROP OP_PUSHDATA2 {len} {data} OP_PUSHDATA2 {len} {data} OP_2DROP OP_DUP OP_HASH160 <address> OP_EQUALVERIFY OP_CHECKSIG
   //  OP_NAME_NEW OP_DROP OP_PUSHDATA2 {len, max 0002} {name} [days] OP_2DROP OP_PUSHDATA2 {len 0802} {data1} OP_PUSHDATA2 {len 0802} {data2} OP_PUSHDATA2 {len 0802} {data 3} OP_PUSHDATA2 {len 0802} {data4} OP_PUSHDATA2 {len 0802} {data 5} ....A LOT OF BLOCKS... OP_PUSHDATA1 {rest len = C8} {last data} OP_2DROP OP_2DROP  OP_2DROP OP_2DROP ..close all blocks.. OP_2DROP OP_2DROP OP_DUP OP_HASH160 <address> OP_EQUALVERIFY OP_CHECKSIG
     checkbox1.Checked:=l[0]=opNum('OP_NAME_NEW');

     edit5.Text:=uq(scriptDataBufToText(l[2],true),CheckBox3);

     s:='';
     i:=5;
     while (i<l.count) and (l.Objects[i]=nil) do begin s:=s+l[i]; inc(i); end;
     Memo2.Text:=uq(scriptDataBufToText(s,true),CheckBox4);


     edit8.Text:=inttostr( BufToInt(l[3]) );

     edit9.Text:=add;
     PageControl1.TabIndex:=1;
   end else if (l.Count=4) and (l[0]=opNum('OP_NAME_DELETE')) and (l[1]=opNum('OP_DROP'))
        and (l.Objects[2]=nil)
        and (l[3]=opNum('OP_DROP'))
   then begin
     //OP_NAME_DELETE OP_DROP [747379] OP_DROP OP_DUP OP_HASH160 [9836ED34086A8A029FE0B2CA1E3EAEF610D91117] OP_EQUALVERIFY OP_CHECKSIG
     //OP_NAME_DELETE OP_DROP [747379] OP_DROP OP_DUP OP_HASH160 [9836ED34086A8A029FE0B2CA1E3EAEF610D91117] OP_EQUALVERIFY OP_CHECKSIG

     edit10.Text:=uq(scriptDataBufToText(l[2],true),CheckBox5);

     edit11.Text:=add;
     PageControl1.TabIndex:=2;

     //https://github.com/emercoin/emercoin/blob/master/src/script/script.h#L425
     //https://github.com/emercoin/emercoin/blob/master/src/prevector.h#L342
   end;
 finally
   l.free;
 end;

{
 if buf()

 i:=1;
 while i<=length(buf) do begin
   c:=ord(buf[i]);
   n:=opcodes.IndexOfObject(tObject(pointer(c)));
//    if n<0 then raise exception.create('Unknown opcode '+inttostr(ord(buf[i])));
   if n>=0 then begin
     i:=i+1;
     result:=result + opcodes[n]+' ';

     if (opcodes[n]='OP_HASH160') and (ord(buf[i])=20) and (addId<>'') then begin
         inc(i);
         result:=result + '<'+buf2Base58Check(addId[1]+pullbuf(20))+'> '
     end;
     //https://github.com/emercoin/emercoin/blob/master/src/namecoin.cpp#L941
   end else //data
     result:=result + '['+pullData+'] ';
 end;
}


end;

procedure TCreateRawTXForm.StringGrid2SelectCell(Sender: TObject; aCol,
  aRow: Integer; var CanSelect: Boolean);
begin
  Memo1.Text:=scriptDecompile(hexToBuf(StringGrid2.Cells[2,aRow]),addId,checkbox2.Checked);
  showScriptData(hexToBuf(StringGrid2.Cells[2,aRow]));
end;

end.

